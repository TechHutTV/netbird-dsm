#!/bin/bash
# Copyright (c) 2024 NetBird DSM Package
# SPDX-License-Identifier: MIT

# Post-installation script
# This script runs after the package is installed
# Environment variables from WIZARD_UIFILES are available here

PACKAGE_DIR="/var/packages/${SYNOPKG_PKGNAME}"
TARGET_DIR="${PACKAGE_DIR}/target"
CONFIG_DIR="${TARGET_DIR}/etc"
DATA_DIR="${TARGET_DIR}/var"
LOG_FILE="${SYNOPKG_TEMP_LOGFILE:-/dev/null}"

# Create necessary directories
mkdir -p "${CONFIG_DIR}"
mkdir -p "${DATA_DIR}"
mkdir -p "${TARGET_DIR}/bin"

# Determine system architecture and download appropriate NetBird binary
ARCH=$(uname -m)
NETBIRD_VERSION="0.60.4"
NETBIRD_BASE_URL="https://github.com/netbirdio/netbird/releases/download/v${NETBIRD_VERSION}"

case "${ARCH}" in
    x86_64|amd64)
        NETBIRD_ARCH="linux_amd64"
        ;;
    aarch64|arm64)
        NETBIRD_ARCH="linux_arm64"
        ;;
    armv7l|armhf)
        NETBIRD_ARCH="linux_armv6"
        ;;
    *)
        echo "Unsupported architecture: ${ARCH}" >> "${LOG_FILE}"
        exit 1
        ;;
esac

NETBIRD_TAR="netbird_${NETBIRD_VERSION}_${NETBIRD_ARCH}.tar.gz"
DOWNLOAD_URL="${NETBIRD_BASE_URL}/${NETBIRD_TAR}"

echo "Downloading NetBird v${NETBIRD_VERSION} for ${ARCH}..." >> "${LOG_FILE}"

# Download NetBird binary
cd /tmp
if ! curl -fsSL -o "${NETBIRD_TAR}" "${DOWNLOAD_URL}"; then
    echo "Failed to download NetBird from ${DOWNLOAD_URL}" >> "${LOG_FILE}"
    exit 1
fi

# Extract and install binary
if ! tar -xzf "${NETBIRD_TAR}" -C "${TARGET_DIR}/bin" netbird; then
    echo "Failed to extract NetBird binary" >> "${LOG_FILE}"
    rm -f "${NETBIRD_TAR}"
    exit 1
fi

rm -f "${NETBIRD_TAR}"
chmod +x "${TARGET_DIR}/bin/netbird"

echo "NetBird binary installed successfully" >> "${LOG_FILE}"

# Create config file from wizard inputs
CONFIG_FILE="${CONFIG_DIR}/netbird.json"

# Default management URL
MGMT_URL="${pkgwizard_management_url:-https://api.netbird.io:443}"
SETUP_KEY="${pkgwizard_setup_key:-}"

# DNS Management setting from wizard
# "true" means DNS management is disabled (safer for Synology with DNS services)
DISABLE_DNS="${pkgwizard_disable_dns:-false}"

# Check for DNS conflict detection from preinst
DNS_STATUS_FILE="/tmp/.netbird_dns_conflict"
DNS_CONFLICT_DETECTED=false
if [ -f "${DNS_STATUS_FILE}" ]; then
    source "${DNS_STATUS_FILE}"
    DNS_CONFLICT_DETECTED="${CONFLICT_DETECTED:-false}"
    rm -f "${DNS_STATUS_FILE}"
fi

# Auto-enable disable_dns if conflicts were detected and user didn't explicitly set it
if [ "${DNS_CONFLICT_DETECTED}" = "true" ] && [ "${DISABLE_DNS}" != "true" ]; then
    echo "DNS conflicts detected, recommending DNS management be disabled." >> "${LOG_FILE}"
    # Note: We don't auto-enable, just log the recommendation
    # The wizard should have prompted the user
fi

echo "DNS Management disabled: ${DISABLE_DNS}" >> "${LOG_FILE}"

# Create initial configuration
cat > "${CONFIG_FILE}" << EOF
{
    "ManagementURL": "${MGMT_URL}",
    "SetupKey": "${SETUP_KEY}",
    "AdminURL": "",
    "ConfigPath": "${CONFIG_DIR}/config.json",
    "LogFile": "${DATA_DIR}/netbird.log",
    "LogLevel": "info",
    "DisableDNS": ${DISABLE_DNS}
}
EOF

chmod 600 "${CONFIG_FILE}"

echo "Configuration file created at ${CONFIG_FILE}" >> "${LOG_FILE}"

# Build netbird up command with optional --disable-dns flag
NETBIRD_UP_CMD="${TARGET_DIR}/bin/netbird up"
NETBIRD_UP_CMD="${NETBIRD_UP_CMD} --config ${CONFIG_DIR}/config.json"
NETBIRD_UP_CMD="${NETBIRD_UP_CMD} --log-file ${DATA_DIR}/netbird.log"
NETBIRD_UP_CMD="${NETBIRD_UP_CMD} --daemon-addr unix://${DATA_DIR}/netbird.sock"

if [ -n "${SETUP_KEY}" ]; then
    NETBIRD_UP_CMD="${NETBIRD_UP_CMD} --setup-key ${SETUP_KEY}"
fi

if [ -n "${MGMT_URL}" ]; then
    NETBIRD_UP_CMD="${NETBIRD_UP_CMD} --management-url ${MGMT_URL}"
fi

if [ "${DISABLE_DNS}" = "true" ]; then
    NETBIRD_UP_CMD="${NETBIRD_UP_CMD} --disable-dns"
    echo "DNS management disabled - NetBird will not modify system DNS settings." >> "${LOG_FILE}"
fi

# If setup key was provided during installation, configure NetBird
if [ -n "${SETUP_KEY}" ]; then
    echo "Setup key provided, configuring NetBird..." >> "${LOG_FILE}"
    eval "${NETBIRD_UP_CMD}" 2>> "${LOG_FILE}" || true
fi

exit 0
